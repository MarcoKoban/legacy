# ============================================================================
# Golden Master Testing Suite - Makefile
# ============================================================================
# Auteur: Geneweb Project
# Description: Makefile pour exÃ©cuter les tests Golden Master (OCaml vs Python)
# ============================================================================

# Variables de configuration
GENEWEB_DIR = ../geneweb-oCaml
OCAML_RUNNER = run_ocaml_tests_fixed
PYTHON_RUNNER = run_python_tests_simple.py
COMPARE_SCRIPT = compare_ocaml_python.py
VALIDATE_SCRIPT = validate_golden_master.py
MAIN_SCRIPT = run_complete_golden_master.sh

# RÃ©pertoires
INPUT_DIR = inputs
OUTPUT_DIR_OCAML = outputs_ocaml
OUTPUT_DIR_PYTHON = outputs_python
REPORTS_DIR = reports

# Couleurs pour l'affichage
BLUE = \033[0;34m
GREEN = \033[0;32m
YELLOW = \033[1;33m
RED = \033[0;31m
NC = \033[0m # No Color

# ============================================================================
# Cibles principales
# ============================================================================

.PHONY: all test run clean fclean re help

# Cible par dÃ©faut
all: test

# Lance tous les tests Golden Master
test: banner
	@echo "$(BLUE)ğŸ§ª Lancement des tests Golden Master...$(NC)"
	@bash $(MAIN_SCRIPT)

# Alias pour test
run: test

# ============================================================================
# Compilation
# ============================================================================

.PHONY: compile compile-ocaml

# Compile le test runner OCaml
compile-ocaml:
	@echo "$(BLUE)ğŸ”¨ Compilation du test runner OCaml...$(NC)"
	@bash -c 'cd $(GENEWEB_DIR) && eval $$(opam env) && \
		ocamlfind ocamlc -package yojson,unix,zarith -linkpkg \
		-I _build/default/lib/sosa/.geneweb_sosa.objs/byte \
		-o ../golden_master/$(OCAML_RUNNER).exe \
		../golden_master/$(OCAML_RUNNER).ml'
	@echo "$(GREEN)âœ“ Compilation terminÃ©e$(NC)"

compile: compile-ocaml

# ============================================================================
# Tests individuels
# ============================================================================

.PHONY: test-ocaml test-python compare validate

# ExÃ©cute uniquement les tests OCaml
test-ocaml: compile-ocaml
	@echo "$(BLUE)ğŸ§ª ExÃ©cution des tests OCaml...$(NC)"
	@mkdir -p $(OUTPUT_DIR_OCAML)
	@./$(OCAML_RUNNER).exe
	@echo "$(GREEN)âœ“ Tests OCaml terminÃ©s$(NC)"

# ExÃ©cute uniquement les tests Python
test-python:
	@echo "$(BLUE)ğŸ ExÃ©cution des tests Python...$(NC)"
	@mkdir -p $(OUTPUT_DIR_PYTHON)
	@python3 $(PYTHON_RUNNER)
	@echo "$(GREEN)âœ“ Tests Python terminÃ©s$(NC)"

# Compare les rÃ©sultats OCaml et Python
compare:
	@echo "$(BLUE)ğŸ” Comparaison des rÃ©sultats...$(NC)"
	@python3 $(COMPARE_SCRIPT)

# Valide les rÃ©sultats OCaml contre les valeurs attendues
validate:
	@echo "$(BLUE)âœ… Validation des rÃ©sultats OCaml...$(NC)"
	@python3 $(VALIDATE_SCRIPT)

# ============================================================================
# Nettoyage
# ============================================================================

.PHONY: clean-outputs clean-ocaml clean-reports

# Supprime les fichiers de sortie
clean-outputs:
	@echo "$(YELLOW)ğŸ§¹ Nettoyage des fichiers de sortie...$(NC)"
	@rm -rf $(OUTPUT_DIR_OCAML)/*.json
	@rm -rf $(OUTPUT_DIR_PYTHON)/*.json
	@echo "$(GREEN)âœ“ Fichiers de sortie supprimÃ©s$(NC)"

# Supprime les exÃ©cutables OCaml et fichiers de compilation
clean-ocaml:
	@echo "$(YELLOW)ğŸ§¹ Nettoyage des fichiers OCaml...$(NC)"
	@rm -f $(OCAML_RUNNER).exe
	@rm -f $(OCAML_RUNNER).cmi
	@rm -f $(OCAML_RUNNER).cmo
	@rm -f $(OCAML_RUNNER).cmx
	@rm -f $(OCAML_RUNNER).o
	@echo "$(GREEN)âœ“ Fichiers OCaml supprimÃ©s$(NC)"

# Supprime les rapports gÃ©nÃ©rÃ©s
clean-reports:
	@echo "$(YELLOW)ğŸ§¹ Nettoyage des rapports...$(NC)"
	@rm -rf $(REPORTS_DIR)/*.txt
	@rm -rf $(REPORTS_DIR)/*.json
	@echo "$(GREEN)âœ“ Rapports supprimÃ©s$(NC)"

# Nettoyage standard (outputs + exÃ©cutables)
clean: clean-outputs clean-ocaml
	@echo "$(GREEN)âœ¨ Nettoyage terminÃ©$(NC)"

# Nettoyage complet (tout supprimer)
fclean: clean clean-reports
	@echo "$(YELLOW)ğŸ§¹ Nettoyage complet...$(NC)"
	@rm -rf $(OUTPUT_DIR_OCAML)
	@rm -rf $(OUTPUT_DIR_PYTHON)
	@rm -rf $(REPORTS_DIR)
	@echo "$(GREEN)âœ¨ Nettoyage complet terminÃ©$(NC)"

# Recompile tout
re: fclean all

# ============================================================================
# Utilitaires
# ============================================================================

.PHONY: banner status dirs help

# Affiche la banniÃ¨re
banner:
	@echo "$(BLUE)â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—$(NC)"
	@echo "$(BLUE)â•‘     ğŸ§ª Golden Master Testing Suite - OCaml vs Python         â•‘$(NC)"
	@echo "$(BLUE)â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo ""

# Affiche le statut des tests
status:
	@echo "$(BLUE)ğŸ“Š Statut des tests Golden Master$(NC)"
	@echo ""
	@echo "$(YELLOW)Fichiers d'entrÃ©e:$(NC)"
	@ls -1 $(INPUT_DIR)/*.json 2>/dev/null | wc -l | xargs echo "  Tests disponibles:"
	@echo ""
	@echo "$(YELLOW)RÃ©sultats OCaml:$(NC)"
	@ls -1 $(OUTPUT_DIR_OCAML)/*.json 2>/dev/null | wc -l | xargs echo "  Fichiers gÃ©nÃ©rÃ©s:"
	@echo ""
	@echo "$(YELLOW)RÃ©sultats Python:$(NC)"
	@ls -1 $(OUTPUT_DIR_PYTHON)/*.json 2>/dev/null | wc -l | xargs echo "  Fichiers gÃ©nÃ©rÃ©s:"
	@echo ""

# CrÃ©e les rÃ©pertoires nÃ©cessaires
dirs:
	@echo "$(BLUE)ğŸ“ CrÃ©ation des rÃ©pertoires...$(NC)"
	@mkdir -p $(INPUT_DIR)
	@mkdir -p $(OUTPUT_DIR_OCAML)
	@mkdir -p $(OUTPUT_DIR_PYTHON)
	@mkdir -p $(REPORTS_DIR)
	@echo "$(GREEN)âœ“ RÃ©pertoires crÃ©Ã©s$(NC)"

# Affiche l'aide
help:
	@echo "$(BLUE)â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—$(NC)"
	@echo "$(BLUE)â•‘           Golden Master Testing Suite - Aide                  â•‘$(NC)"
	@echo "$(BLUE)â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo ""
	@echo "$(GREEN)Cibles principales:$(NC)"
	@echo "  $(YELLOW)make$(NC) ou $(YELLOW)make test$(NC)     - Lance tous les tests (OCaml + Python + comparaison)"
	@echo "  $(YELLOW)make run$(NC)              - Alias pour 'make test'"
	@echo "  $(YELLOW)make clean$(NC)            - Supprime les outputs et exÃ©cutables"
	@echo "  $(YELLOW)make fclean$(NC)           - Nettoyage complet (outputs + rapports + rÃ©pertoires)"
	@echo "  $(YELLOW)make re$(NC)               - Recompile tout (fclean + test)"
	@echo ""
	@echo "$(GREEN)Tests individuels:$(NC)"
	@echo "  $(YELLOW)make test-ocaml$(NC)       - ExÃ©cute uniquement les tests OCaml"
	@echo "  $(YELLOW)make test-python$(NC)      - ExÃ©cute uniquement les tests Python"
	@echo "  $(YELLOW)make compare$(NC)          - Compare les rÃ©sultats OCaml vs Python"
	@echo "  $(YELLOW)make validate$(NC)         - Valide les rÃ©sultats OCaml"
	@echo ""
	@echo "$(GREEN)Compilation:$(NC)"
	@echo "  $(YELLOW)make compile$(NC)          - Compile le test runner OCaml"
	@echo "  $(YELLOW)make compile-ocaml$(NC)    - Compile le test runner OCaml"
	@echo ""
	@echo "$(GREEN)Nettoyage:$(NC)"
	@echo "  $(YELLOW)make clean-outputs$(NC)    - Supprime uniquement les fichiers JSON de sortie"
	@echo "  $(YELLOW)make clean-ocaml$(NC)      - Supprime uniquement les exÃ©cutables OCaml"
	@echo "  $(YELLOW)make clean-reports$(NC)    - Supprime uniquement les rapports"
	@echo ""
	@echo "$(GREEN)Utilitaires:$(NC)"
	@echo "  $(YELLOW)make status$(NC)           - Affiche le statut des tests"
	@echo "  $(YELLOW)make dirs$(NC)             - CrÃ©e les rÃ©pertoires nÃ©cessaires"
	@echo "  $(YELLOW)make help$(NC)             - Affiche cette aide"
	@echo ""
	@echo "$(BLUE)Exemples d'utilisation:$(NC)"
	@echo "  $(YELLOW)make$(NC)                  - Lance tous les tests"
	@echo "  $(YELLOW)make test-ocaml$(NC)       - Teste uniquement OCaml"
	@echo "  $(YELLOW)make clean && make$(NC)    - Nettoie et relance les tests"
	@echo ""
