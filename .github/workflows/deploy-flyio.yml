name: ğŸš€ Deploy to Fly.io

on:
  push:
    branches: [ main ]
    paths:
      - 'geneweb_python/**'
      - '.github/workflows/deploy-flyio.yml'
  pull_request:
    branches:
      - main
    types: [closed]
  workflow_dispatch:


jobs:
  # Job de tests avant dÃ©ploiement
  test:
    name: ğŸ§ª Run Tests
    runs-on: [self-hosted]
    defaults:
      run:
        working-directory: ./geneweb_python

    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4

    - name: ğŸ Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"

    - name: ğŸ§ª Run pytest
      run: |
        pytest tests/ -v --cov=src --cov-report=term-missing
      env:
        TESTING: "1"

  # Job de dÃ©ploiement sur Fly.io
  deploy:
    name: ğŸš€ Deploy to Fly.io
    runs-on: [self-hosted]
    needs: test  # DÃ©ploie seulement si les tests passent
    # DÃ©ploiement uniquement sur la branche main (production)
    # Pour dev, on peut crÃ©er une app Fly.io sÃ©parÃ©e (staging)
    if: github.ref == 'refs/heads/main'

    defaults:
      run:
        working-directory: ./geneweb_python

    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4

    - name: ğŸ¯ Setup Fly.io CLI
      uses: superfly/flyctl-actions/setup-flyctl@master

    - name: ğŸš€ Deploy to Fly.io
      run: flyctl deploy --remote-only
      env:
        FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

    - name: âœ… Verify Deployment
      run: |
        echo "ğŸ‰ Deployment completed!"
        echo "ğŸ”— Application URL: https://geneweb-api.fly.dev"
        echo "ğŸ¥ Health check: https://geneweb-api.fly.dev/health/"
        
        # Attendre que l'application dÃ©marre
        sleep 10
        
        # VÃ©rifier le health check
        curl -f https://geneweb-api.fly.dev/health/ || exit 1
        echo "âœ… Health check passed!"

  # Job optionnel pour dÃ©ployer sur un environnement de staging (dev)
  deploy-staging:
    name: ğŸ§ª Deploy to Staging (dev)
    runs-on: [self-hosted]
    needs: test
    if: github.ref == 'refs/heads/dev'

    defaults:
      run:
        working-directory: ./geneweb_python

    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4

    - name: ğŸ¯ Setup Fly.io CLI
      uses: superfly/flyctl-actions/setup-flyctl@master

    - name: ğŸ§ª Deploy to Staging
      run: |
        # DÃ©ployer sur une app staging sÃ©parÃ©e (Ã  crÃ©er)
        # flyctl deploy --remote-only --app geneweb-api-staging
        echo "âš ï¸ Staging deployment not configured yet"
        echo "To enable: Create 'geneweb-api-staging' app on Fly.io"
        echo "and uncomment the flyctl deploy command above"
      env:
        FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

  # Notification de dÃ©ploiement (optionnel)
  notify:
    name: ğŸ“¢ Notify Deployment
    runs-on: [self-hosted]
    needs: [deploy, deploy-staging]
    if: always()

    steps:
    - name: ğŸ“¢ Deployment Status
      run: |
        if [ "${{ needs.deploy.result }}" == "success" ]; then
          echo "âœ… Production deployment successful!"
        elif [ "${{ needs.deploy-staging.result }}" == "success" ]; then
          echo "âœ… Staging deployment successful!"
        else
          echo "âŒ Deployment failed"
          exit 1
        fi
